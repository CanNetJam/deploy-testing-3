(()=>{var t={866:(t,e,a)=>{const s=a(344);t.exports=(t,e,a)=>{const o=t.header("auth-token");if(!o)return e.status(401).json({msg:"No Token - Authorization Denied"});try{const n=s.verify(o,process.env.JWT_SECRET);if(!n)return e.status(401).json({msg:"Cannot Verify - Authorization Denied"});t.user=n,a()}catch(t){e.status(401).json({msg:t})}}},175:(t,e,a)=>{const s=a(185),o=new s.Schema({type:{type:String,required:!0},firstname:String,lastname:String,middlename:String,age:Number,address:String,location:{region:{type:String},province:{type:String},city:{type:String}},sex:String,email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},skill:[String],about:{type:String,default:""},photo:{type:String},image:{type:String},resume:{type:String},ratings:[Number],averagerating:{type:Number,default:0},company:String,position:String,companyinfo:{companyname:String,establishdate:Number,details:String,logo:String,companysize:Number,location:{region:{type:String},province:{type:String},city:{type:String}}},currentprojects:[{type:s.Schema.Types.ObjectId,ref:"projects"}],lastactive:{type:Date,default:()=>Date.now()},phone:Number,degree:{school:String,course:String,degreetitle:String},citizenship:String},{timestamps:!0});t.exports=s.model("accounts",o)},766:(t,e,a)=>{const s=a(185),o=new s.Schema({candidate:{type:s.Schema.Types.ObjectId,ref:"accounts"},project:{type:s.Schema.Types.ObjectId,ref:"projects"},answers:[String]},{timestamps:!0});t.exports=s.model("answers",o)},884:(t,e,a)=>{const s=a(185),o=new s.Schema({userid:{type:s.Schema.Types.ObjectId,ref:"accounts"},title:{type:String},photo:{type:String},description:{type:String}},{timestamps:!0});t.exports=s.model("bugreports",o)},755:(t,e,a)=>{const s=a(185),o=new s.Schema({name:String,tags:{type:Array},tagscount:{type:Number,default:1}},{timestamps:!0});t.exports=s.model("categories",o)},685:(t,e,a)=>{const s=a(185),o=new s.Schema({members:{type:Array},messages:{type:Number,default:0}},{timestamps:!0});t.exports=s.model("conversations",o)},46:(t,e,a)=>{const s=a(185),o=new s.Schema({userId:{type:s.Schema.Types.ObjectId,ref:"accounts"},username:{type:String},title:{type:String},photo:{type:String},image:{type:String},description:{type:String}},{timestamps:!0});t.exports=s.model("gallery",o)},266:(t,e,a)=>{const s=a(185),o=new s.Schema({type:{type:String},adminId:{type:s.Schema.Types.ObjectId,ref:"accounts"},userId:{type:s.Schema.Types.ObjectId,ref:"accounts"},projectId:{type:s.Schema.Types.ObjectId,ref:"projects"}},{timestamps:!0});t.exports=s.model("logs",o)},598:(t,e,a)=>{const s=a(185),o=new s.Schema({conversationId:{type:String},sender:{type:String},text:{type:String}},{timestamps:!0});t.exports=s.model("message",o)},893:(t,e,a)=>{const s=a(185),o=new s.Schema({type:{type:String},senderId:{type:s.Schema.Types.ObjectId,ref:"accounts"},recieverId:{type:s.Schema.Types.ObjectId,ref:"accounts"},subject:{type:s.Schema.Types.ObjectId,ref:"projects"},action:{type:String},cleared:{type:String,default:"No"}},{timestamps:!0});t.exports=s.model("notifications",o)},319:(t,e,a)=>{const s=a(185),o=new s.Schema({projectId:{type:String},title:{type:String},photo:{type:String},image:{type:String},description:{type:String},uploadedby:{type:String},note:{type:String}},{timestamps:!0});t.exports=s.model("pUpdates",o)},458:(t,e,a)=>{const s=a(185),o=new s.Schema({type:{type:String,required:!0},requeststatus:{type:String,default:"Pending"},status:{type:String},title:{type:String,required:!0},company:{type:String},description:{type:String,required:!0},skillrequired:{type:String,required:!0},sallary:{type:Number,required:!0},duration:{type:Number,required:!0},location:{region:{type:String},province:{type:String},city:{type:String}},employmenttype:{type:String,required:!0},image:{type:String},employer:{type:s.Schema.Types.ObjectId,ref:"accounts"},slots:{type:Number,required:!0},tempcandidate:[{applicantid:{type:s.Schema.Types.ObjectId,ref:"accounts"},employmentstatus:{type:String},hiredAt:{type:Date,immutable:!0,default:()=>Date.now()}}],employeelist:[{employeeid:{type:s.Schema.Types.ObjectId,ref:"accounts"},employmentstatus:{type:String},beganAt:{type:Date},completiondate:{type:Date}}],gallery:{photo:{type:String},description:{type:String}},applicants:[{applicantid:{type:s.Schema.Types.ObjectId,ref:"accounts"},appliedAt:{type:Date}}],creationdate:{type:Date,immutable:!0,default:()=>Date.now()},approvaldate:{type:Date},completiondate:{type:Date},notes:[{notesender:{type:s.Schema.Types.ObjectId,ref:"accounts"},note:{type:String}}],others:{type:String},minimumreq:[{what:{type:String},note:{type:String}}],questions:[String],note:{type:String},expirationdate:{type:Date}});t.exports=s.model("projects",o)},794:(t,e,a)=>{const s=a(185),o=new s.Schema({projectId:{type:String},candidate:{type:String},freename:{type:String},photo:{type:String},description:{type:String},uploadedby:{type:String},empname:{type:String},rating:{type:Number}},{timestamps:!0});t.exports=s.model("reviews",o)},96:t=>{"use strict";t.exports=require("bcrypt")},518:t=>{"use strict";t.exports=require("cloudinary")},582:t=>{"use strict";t.exports=require("cors")},142:t=>{"use strict";t.exports=require("dotenv")},860:t=>{"use strict";t.exports=require("express")},444:t=>{"use strict";t.exports=require("express-favicon")},470:t=>{"use strict";t.exports=require("fs-extra")},344:t=>{"use strict";t.exports=require("jsonwebtoken")},13:t=>{"use strict";t.exports=require("mongodb")},185:t=>{"use strict";t.exports=require("mongoose")},738:t=>{"use strict";t.exports=require("multer")},109:t=>{"use strict";t.exports=require("sanitize-html")},952:t=>{"use strict";t.exports=require("socket.io")},147:t=>{"use strict";t.exports=require("fs")},17:t=>{"use strict";t.exports=require("path")}},e={};function a(s){var o=e[s];if(void 0!==o)return o.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,a),n.exports}(()=>{const{ObjectId:t}=a(13),e=a(860),s=a(444),o=a(738),n=a(17),r=a(109),d=a(470),p=a(96),c=a(185),l=a(344),y=a(866),m=(a(147),a(582)),u=a(518).v2;a(142).config();const g=a(175),b=a(458),w=a(685),h=a(598),f=a(755),j=a(319),v=a(794),q=a(46),$=a(893),S=a(766),A=a(884),I=a(266);d.ensureDirSync(n.join("public","uploaded-photos"));const _=e();_.use(e.static("public")),_.use(e.json()),_.use(e.urlencoded({extended:!1})),_.use(m()),_.use(s(__dirname+"/public/favicon.png"));const D=process.env.PORT||3e3,T=_.listen(D,console.log(`Node server started at port ${D}`)),x=a(952)(T,{cors:{origin:"https://deploy-testing-3.onrender.com",methods:["GET","POST"]}}),O=u.config({cloud_name:process.env.CLOUDNAME,api_key:process.env.CLOUDAPIKEY,api_secret:process.env.CLOUDINARYSECRET,secure:!0}),k=o.diskStorage({destination:(t,e,a)=>{a(null,n.join("public","uploaded-photos"))},filename:(t,e,a)=>{a(null,Date.now()+n.extname(e.originalname))}}),U=o({storage:k});c.connect(process.env.CONNECTIONSTRING,{useNewUrlParser:!0,useUnifiedTopology:!0});let R=[];const N=t=>R.find((e=>e.userId===t));x.on("connection",(t=>{console.log("A user has been connected."),t.on("addUser",(e=>{((t,e)=>{!R.some((e=>e.userId===t))&&R.push({userId:t,socketId:e})})(e,t.id),x.emit("getUsers",R)})),t.on("disconnect",(()=>{var e;console.log("A user has been disconnected!"),e=t.id,R=R.filter((t=>t.socketId!==e)),x.emit("getUsers",R)})),t.on("sendMessage",(({senderId:t,receiverId:e,text:a})=>{const s=N(e);s?x.to(s.socketId).emit("getMessage",{senderId:t,text:a}):console.log("the user is not online right now")})),t.on("sendNotification",(({senderId:t,receiverId:e,subject:a,type:s,action:o})=>{const n=N(e);n?x.to(n.socketId).emit("getNotification",{senderId:t,subject:a,type:s,action:o}):console.log("the user is not online right now")}))})),_.get("/",((t,e)=>{e.render("index",{})})),_.get("/get-signature",((t,e)=>{const a=Math.round((new Date).getTime()/1e3),s=u.utils.api_sign_request({timestamp:a},O.api_secret);e.json({timestamp:a,signature:s})})),_.get("/api/hiring-search",(async(t,e)=>{const a=t.query.query,s=t.query.location,o=t.query.sallary,n=t.query.key,i=t.query.sort,r=function(t){let e,a;return""===t?(e="Job",a="Project",{b:e,c:a}):"Job Hiring"===t?(e="Job",a="Job",{b:e,c:a}):"Project Hiring"===t?(e="Project",a="Project",{b:e,c:a}):void 0}(n),d=function(t){let e,a;return"A-Z"===t?(e="skillrequired",a="1",{b:e,c:a}):"Z-A"===t?(e="skillrequired",a="-1",{b:e,c:a}):"Longest Duration"===t?(e="duration",a="-1",{b:e,c:a}):"Shortest Duration"===t?(e="duration",a="1",{b:e,c:a}):void 0}(i);let p=function(t){let e,a;return"1"===t?(e=0,a=1e4,{b:e,c:a}):"2"===t?(e=10001,a=25e3,{b:e,c:a}):"3"===t?(e=25001,a=5e4,{b:e,c:a}):"4"===t?(e=50001,a=1e5,{b:e,c:a}):"5"===t?(e=1e5,a=9999999,{b:e,c:a}):""===t?(e=0,a=9999999,{b:e,c:a}):void 0}(o);try{const t=await b.find({$and:[{skillrequired:new RegExp(a,"i"),$or:[{type:r.b},{type:r.c}],status:"Hiring"},{$or:[{"location.province":new RegExp(s,"i")},{"location.region":new RegExp(s,"i")},{"location.city":new RegExp(s,"i")}]},{$and:[{sallary:{$gte:p.b}},{sallary:{$lte:p.c}}]},{expirationdate:{$gte:Date.now()}}]}).collation({locale:"en",strength:2}).populate({path:"employer",select:["firstname","middlename","lastname"]}).sort({[d.b]:[d.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/all-accounts",y,(async(t,e)=>{const a=t.query.query,s=t.query.key,o=function(t){let e,a;return"A-Z (First Name)"===t?(e="firstname",a="1",{b:e,c:a}):"Z-A (First Name)"===t?(e="firstname",a="-1",{b:e,c:a}):"A-Z (Last Name)"===t?(e="lastname",a="1",{b:e,c:a}):"Z-A (Last Name)"===t?(e="lastname",a="-1",{b:e,c:a}):"Highest Rating"===t?(e="averagerating",a="-1",{b:e,c:a}):"Lowest Rating"===t?(e="averagerating",a="1",{b:e,c:a}):void 0}(t.query.sort);if("Skill"===s)try{const t=await g.find({skill:new RegExp(a,"i"),type:{$in:["Candidate","Employer"]}}).collation({locale:"en",strength:2}).sort({[o.b]:[o.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}if("Name"===s)try{const t=await g.find({$or:[{firstname:new RegExp(a,"i")},{lastname:new RegExp(a,"i")}],type:{$in:["Candidate","Employer"]}}).collation({locale:"en",strength:2}).sort({[o.b]:[o.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/pending-projects/:type",y,(async(t,e)=>{if("Admin"===t.params.type)try{const t=await b.find({type:{$in:["Job Request","Project Request","Job","Project"]},requeststatus:"Pending"}).populate({path:"employer",select:["firstname","middlename","lastname","company"]}).sort({creationdate:-1});e.status(200).json(t)}catch(t){e.status(400).json(t)}else e.status(400).send(!1)})),_.get("/api/denied-projects/:type",y,(async(t,e)=>{if("Admin"===t.params.type)try{const t=await b.find({type:{$in:["Job Request","Job","Project Request","Project"]},requeststatus:"Denied"}).populate({path:"employer",select:["firstname","middlename","lastname"]});e.status(200).json(t)}catch(t){e.status(400).json(t)}else e.status(400).send(!1)})),_.get("/api/all-approved-projects/",y,(async(t,e)=>{const a=t.query.query,s=t.query.location,o=t.query.sallary,n=t.query.key,i=t.query.sort,r=function(t){let e,a;return""===t?(e="Job",a="Project",{b:e,c:a}):"Job Hiring"===t?(e="Job",a="Job",{b:e,c:a}):"Project Hiring"===t?(e="Project",a="Project",{b:e,c:a}):void 0}(n),d=function(t){let e,a;return"A-Z"===t?(e="skillrequired",a="1",{b:e,c:a}):"Z-A"===t?(e="skillrequired",a="-1",{b:e,c:a}):"Latest"===t?(e="approvaldate",a="-1",{b:e,c:a}):"Oldest"===t?(e="approvaldate",a="1",{b:e,c:a}):void 0}(i);let p=function(t){let e,a;return"1"===t?(e=0,a=1e4,{b:e,c:a}):"2"===t?(e=10001,a=25e3,{b:e,c:a}):"3"===t?(e=25001,a=5e4,{b:e,c:a}):"4"===t?(e=50001,a=1e5,{b:e,c:a}):"5"===t?(e=1e5,a=9999999,{b:e,c:a}):""===t?(e=0,a=9999999,{b:e,c:a}):void 0}(o);if("Admin"===t.query.usertype||"Super Administrator"===t.query.usertype)try{const t=await b.find({$and:[{skillrequired:new RegExp(a,"i"),$or:[{type:r.b},{type:r.c}],requeststatus:"Approved"},{$or:[{"location.province":new RegExp(s,"i")},{"location.region":new RegExp(s,"i")},{"location.city":new RegExp(s,"i")}]},{$and:[{sallary:{$gte:p.b}},{sallary:{$lte:p.c}}]}]}).collation({locale:"en",strength:2}).populate({path:"employer",select:["firstname","middlename","lastname"]}).populate({path:"employeelist.employeeid",select:["firstname","middlename","lastname"]}).sort({[d.b]:[d.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/deactivate-account/:userid",y,(async(e,a)=>{try{const s=await g.findByIdAndUpdate({_id:new t(e.params.userid)},{skill:[]});a.status(200).json(s)}catch(t){a.status(500).json(t)}})),_.post("/api/create-account/:type",U.single("photo"),y,(function(t,e,a){"string"!=typeof t.body.firstname&&(t.body.firstname=""),"string"!=typeof t.body.lastname&&(t.body.lastname=""),"string"!=typeof t.body.middlename&&(t.body.middlename=""),"string"!=typeof t.body.age&&(t.body.age=""),"string"!=typeof t.body.region&&(t.body.region=""),"string"!=typeof t.body.province&&(t.body.province=""),"string"!=typeof t.body.city&&(t.body.city=""),"string"!=typeof t.body._id&&(t.body._id=""),"string"!=typeof t.body.email&&(t.body.email=""),"string"!=typeof t.body.password&&(t.body.password=""),"string"!=typeof t.body.type&&(t.body.type=""),"string"!=typeof t.body.sex&&(t.body.sex=""),t.cleanData={firstname:r(t.body.firstname.trim(),{allowedTags:[],allowedAttributes:{}}),lastname:r(t.body.lastname.trim(),{allowedTags:[],allowedAttributes:{}}),middlename:r(t.body.middlename.trim(),{allowedTags:[],allowedAttributes:{}}),age:r(t.body.age.trim(),{allowedTags:[],allowedAttributes:{}}),region:r(t.body.region.trim(),{allowedTags:[],allowedAttributes:{}}),province:r(t.body.province.trim(),{allowedTags:[],allowedAttributes:{}}),city:r(t.body.city.trim(),{allowedTags:[],allowedAttributes:{}}),email:r(t.body.email.trim(),{allowedTags:[],allowedAttributes:{}}),password:r(t.body.password.trim(),{allowedTags:[],allowedAttributes:{}}),type:r(t.body.type.trim(),{allowedTags:[],allowedAttributes:{}}),sex:r(t.body.sex.trim(),{allowedTags:[],allowedAttributes:{}})},a()}),(async(t,e)=>{if(await g.findOne({email:t.body.email}))return e.status(200).send(!1);const a=await p.hash(t.body.password,10);if(t.cleanData.password=a,t.file){t.cleanData.photo=t.file.filename;const a={firstname:t.cleanData.firstname,lastname:t.cleanData.lastname,middlename:t.cleanData.middlename,age:t.cleanData.age,location:{region:t.cleanData.region,province:t.cleanData.province,city:t.cleanData.city},email:t.cleanData.email,password:t.cleanData.password,photo:t.cleanData.photo,type:t.cleanData.type,sex:t.cleanData.sex,phone:t.body.phone,citizenship:t.body.citizenship,degree:{school:t.body.school,course:t.body.course,degreetitle:t.body.degree},companyinfo:{companyname:"",establishdate:null,details:"",logo:null,companysize:0,location:{region:"",province:"",city:""}}};await g.create(a,((t,a)=>{t?console.log(t):e.status(200).send(!0)}))}else{const a={firstname:t.cleanData.firstname,lastname:t.cleanData.lastname,middlename:t.cleanData.middlename,age:t.cleanData.age,location:{region:t.cleanData.region,province:t.cleanData.province,city:t.cleanData.city},email:t.cleanData.email,password:t.cleanData.password,photo:t.cleanData.photo,type:t.cleanData.type,sex:t.cleanData.sex,phone:t.body.phone,citizenship:t.body.citizenship,degree:{school:t.body.school,course:t.body.course,degreetitle:t.body.degree},companyinfo:{companyname:"",establishdate:null,details:"",logo:null,companysize:0,location:{region:"",province:"",city:""}}};await g.create(a),e.status(200).send(!0)}})),_.post("/api/login",(function(t,e,a){"string"!=typeof t.body.email&&(t.body.email=""),"string"!=typeof t.body.password&&(t.body.password=""),t.cleanData={email:r(t.body.email.trim(),{allowedTags:[],allowedAttributes:{}}),password:r(t.body.password.trim(),{allowedTags:[],allowedAttributes:{}})},a()}),(async(t,e)=>{const a=await g.findOne({email:t.cleanData.email});if(a||e.send(!1),a){const s=await p.compare(t.cleanData.password,a.password);if(s||e.send(!1),s){const t=l.sign({_id:a._id},process.env.JWT_SECRET);e.json({token:t,user:{id:g._id,firstname:g.firstname,lastname:g.lastname,middlename:g.middlename}})}}})),_.post("/api/logout/:userid",(async(e,a)=>{const s=await g.findOne({_id:e.params.userid});s||a.status(500).send(!1),s&&(await g.findByIdAndUpdate({_id:new t(e.params.userid)},{$set:{lastactive:Date.now()}}),a.status(200).send(s))})),_.get("/profile/user",y,(async(t,e)=>{const a=await g.findById(t.user._id).populate({path:"currentprojects",select:["type","title","duration","acceptdate"]});e.json({id:a._id,firstname:a.firstname,lastname:a.lastname,middlename:a.middlename,sex:a.sex,age:a.age,location:{region:a.location.region,province:a.location.province,city:a.location.city},address:a.address,skill:a.skill,about:a.about,photo:a.photo,image:a.image,type:a.type,email:a.email,company:a.company,position:a.position,currentprojects:a.currentprojects,ratings:a.ratings,averagerating:a.averagerating,lastactive:a.lastactive,companyinfo:a.companyinfo})})),_.post("/update-account",U.single("photo"),(function(t,e,a){"string"!=typeof t.body.firstname&&(t.body.firstname=""),"string"!=typeof t.body.lastname&&(t.body.lastname=""),"string"!=typeof t.body.middlename&&(t.body.middlename=""),"string"!=typeof t.body.age&&(t.body.age=""),"string"!=typeof t.body.address&&(t.body.address=""),"string"!=typeof t.body._id&&(t.body._id=""),"string"!=typeof t.body.about&&(t.body._about=""),"string"!=typeof t.body.company&&(t.body.company=""),"string"!=typeof t.body.position&&(t.body.position=""),t.cleanData={firstname:r(t.body.firstname.trim(),{allowedTags:[],allowedAttributes:{}}),lastname:r(t.body.lastname.trim(),{allowedTags:[],allowedAttributes:{}}),middlename:r(t.body.middlename.trim(),{allowedTags:[],allowedAttributes:{}}),age:r(t.body.age.trim(),{allowedTags:[],allowedAttributes:{}}),address:r(t.body.address.trim(),{allowedTags:[],allowedAttributes:{}}),about:r(t.body.about.trim(),{allowedTags:[],allowedAttributes:{}}),company:r(t.body.company.trim(),{allowedTags:[],allowedAttributes:{}}),position:r(t.body.position.trim(),{allowedTags:[],allowedAttributes:{}})},a()}),(async(e,a)=>{const s={region:e.body.region,province:e.body.province,city:e.body.city};if(e.file){u.utils.api_sign_request({public_id:e.body.public_id,version:e.body.version},O.api_secret)===e.body.signature&&(e.cleanData.image=e.body.image),e.cleanData.photo=e.file.filename,e.cleanData.location=s;const o=await g.findOneAndUpdate({_id:new t(e.body._id)},{$set:e.cleanData,location:{region:e.body.region,province:e.body.province,city:e.body.city}});o.photo&&d.remove(n.join("public","uploaded-photos",o.photo)),o.image&&u.uploader.destroy(o.image),a.send(e.body.image)}else e.cleanData.location=s,await g.findOneAndUpdate({_id:new t(e.body._id)},{$set:e.cleanData}),a.send(!1)})),_.delete("/account/:id",(async(e,a)=>{"string"!=typeof e.params.id&&(e.params.id="");const s=await g.findOne({_id:new t(e.params.id)});s.photo&&d.remove(n.join("public","uploaded-photos",s.photo)),await g.deleteOne(s)})),_.post("/create-project",U.single("photo"),(function(t,e,a){"string"!=typeof t.body.title&&(t.body.title=""),"string"!=typeof t.body.type&&(t.body.type=""),"string"!=typeof t.body.company&&(t.body.company=""),"string"!=typeof t.body.description&&(t.body.description=""),"string"!=typeof t.body.skillrequired&&(t.body.skillrequired=""),"string"!=typeof t.body.employer&&(t.body.employer=""),"string"!=typeof t.body.sallary&&(t.body.sallary=""),"string"!=typeof t.body.duration&&(t.body.duration=""),"string"!=typeof t.body.location&&(t.body.location=""),"string"!=typeof t.body.others&&(t.body.others=""),t.cleanData={title:r(t.body.title.trim(),{allowedTags:[],allowedAttributes:{}}),type:r(t.body.type.trim(),{allowedTags:[],allowedAttributes:{}}),company:r(t.body.company.trim(),{allowedTags:[],allowedAttributes:{}}),description:r(t.body.description.trim(),{allowedTags:[],allowedAttributes:{}}),skillrequired:r(t.body.skillrequired.trim(),{allowedTags:[],allowedAttributes:{}}),employer:r(t.body.employer.trim(),{allowedTags:[],allowedAttributes:{}}),sallary:r(t.body.sallary.trim(),{allowedTags:[],allowedAttributes:{}}),duration:r(t.body.duration.trim(),{allowedTags:[],allowedAttributes:{}}),location:r(t.body.location.trim(),{allowedTags:[],allowedAttributes:{}}),others:r(t.body.others.trim(),{allowedTags:[],allowedAttributes:{}})},a()}),(async(t,e)=>{if(t.file){u.utils.api_sign_request({public_id:t.body.public_id,version:t.body.version},O.api_secret)===t.body.signature&&(t.cleanData.image=t.body.image),t.cleanData.photo=t.file.filename;let a=[];for(let e=0;e<t.body.minimumreq.length;e++)a=a.concat({what:t.body.minimumreq[e],note:"Others"===t.body.minimumreq[e]?t.body.reqspecified:""});const s={title:t.cleanData.title,type:t.cleanData.type,employmenttype:t.body.employmenttype,company:t.cleanData.company,description:t.cleanData.description,skillrequired:t.cleanData.skillrequired,photo:t.cleanData.photo,employer:t.cleanData.employer,sallary:t.cleanData.sallary,slots:t.body.slots,duration:t.cleanData.duration,location:{region:t.body.region,province:t.body.province,city:t.body.city},others:t.cleanData.others,image:t.cleanData.image,minimumreq:a,questions:[t.body.question1,t.body.question2,t.body.question3,t.body.question4,t.body.question5,t.body.question6,t.body.question7,t.body.question8,t.body.question9,t.body.question10]};b.create(s,((t,a)=>{t?console.log(t):e.status(200).json(a)}))}else{let a=[];for(let e=0;e<t.body.minimumreq.length;e++)a=a.concat({what:t.body.minimumreq[e],note:"Others"===t.body.minimumreq[e]?t.body.reqspecified:""});const s={title:t.cleanData.title,type:t.cleanData.type,employmenttype:t.body.employmenttype,company:t.cleanData.company,description:t.cleanData.description,skillrequired:t.cleanData.skillrequired,photo:t.cleanData.photo,employer:t.cleanData.employer,sallary:t.cleanData.sallary,slots:t.body.slots,duration:t.cleanData.duration,location:{region:t.body.region,province:t.body.province,city:t.body.city},others:t.cleanData.others,image:t.body.image,minimumreq:a,questions:[t.body.question1,t.body.question2,t.body.question3,t.body.question4,t.body.question5,t.body.question6,t.body.question7,t.body.question8,t.body.question9,t.body.question10]},o=await b.create(s);e.status(200).json(o)}})),_.post("/update-project",U.single("photo"),(function(t,e,a){"string"!=typeof t.body.requeststatus&&(t.body.requeststatus=""),"string"!=typeof t.body.title&&(t.body.title=""),"string"!=typeof t.body.company&&(t.body.company=""),"string"!=typeof t.body.description&&(t.body.description=""),"string"!=typeof t.body.skillrequired&&(t.body.skillrequired=""),"string"!=typeof t.body.employer&&(t.body.employer=""),"string"!=typeof t.body.type&&(t.body.type=""),"string"!=typeof t.body.status&&(t.body.status=""),"string"!=typeof t.body.note&&(t.body.note=""),"string"!=typeof t.body.approvaldate&&(t.body.approvaldate=""),"string"!=typeof t.body.sallary&&(t.body.sallary=""),"string"!=typeof t.body.duration&&(t.body.duration=""),t.cleanData={requeststatus:r(t.body.requeststatus.trim(),{allowedTags:[],allowedAttributes:{}}),title:r(t.body.title.trim(),{allowedTags:[],allowedAttributes:{}}),company:r(t.body.company.trim(),{allowedTags:[],allowedAttributes:{}}),description:r(t.body.description.trim(),{allowedTags:[],allowedAttributes:{}}),skillrequired:r(t.body.skillrequired.trim(),{allowedTags:[],allowedAttributes:{}}),employer:r(t.body.employer.trim(),{allowedTags:[],allowedAttributes:{}}),type:r(t.body.type.trim(),{allowedTags:[],allowedAttributes:{}}),status:r(t.body.status.trim(),{allowedTags:[],allowedAttributes:{}}),note:r(t.body.note.trim(),{allowedTags:[],allowedAttributes:{}}),approvaldate:r(t.body.approvaldate.trim(),{allowedTags:[],allowedAttributes:{}}),sallary:r(t.body.sallary.trim(),{allowedTags:[],allowedAttributes:{}}),duration:r(t.body.duration.trim(),{allowedTags:[],allowedAttributes:{}})},a()}),(async(e,a)=>{if(e.cleanData.location={region:e.body.region,province:e.body.province,city:e.body.city},e.body.approvaldate){let t=(s=e.body.approvaldate,30,(o=new Date(s)).setDate(o.getDate()+30),o);e.cleanData.expirationdate=t}var s,o;try{const s=await b.findByIdAndUpdate({_id:new t(e.body._id)},{$set:e.cleanData});a.status(200).json(s)}catch(t){a.status(500).json(t)}})),_.get("/api/all-projects-expiry/:userid",y,(async(e,a)=>{try{function s(t,e){var a=new Date(t);return a.setDate(a.getDate()+e),a}let o=s(Date.now(),5);const n=await b.find({employer:new t(e.params.userid),type:["Job","Project"],status:"Hiring",expirationdate:{$lte:o}});let r=[];for(i=0;i<n.length;i++)s(n[i].expirationdate,-5)<=o&&(r=r.concat([n[i]]));a.status(200).json(r)}catch(d){a.status(500).json(d)}})),_.get("/api/check-existing-notif/:senderid/:action/:type/:subject",(async(e,a)=>{try{const s=await $.find({senderId:new t(e.params.senderid),recieverId:new t(e.params.senderid),type:e.params.type,subject:e.params.subject}).populate({path:"senderId",select:["firstname","middlename","lastname","image"]}).sort({createdAt:-1});a.status(200).json(s)}catch(t){a.status(500).json(t)}})),_.get("/api/projects/:id/:tab",(async(e,a)=>{try{"string"!=typeof e.params.id&&(e.params.id="");const s=await b.find({$or:[{employer:new t(e.params.id)},{tempcandidate:{$elemMatch:{applicantid:e.params.id}}},{employeelist:{$elemMatch:{employeeid:e.params.id}}},{applicants:{$elemMatch:{applicantid:e.params.id}}}],type:["Job","Project"],status:e.params.tab}).populate({path:"employer",select:["firstname","middlename","lastname"]}).populate({path:"tempcandidate",select:["firstname","middlename","lastname"]}).populate({path:"employeelist",select:["firstname","middlename","lastname"]}).sort({approvaldate:-1});a.status(200).json(s)}catch(t){a.status(500).json(t)}})),_.get("/api/pending-requests/:id/:tab",(async(e,a)=>{let s;"Pending"===e.params.tab&&(s="Pending"),"Denied"===e.params.tab&&(s="Denied");try{"string"!=typeof e.params.id&&(e.params.id="");const o=await b.find({employer:new t(e.params.id),type:{$in:["Job Request","Project Request"]},requeststatus:[s]}).populate({path:"employer",select:["firstname","lastname"]}).sort({creationdate:-1});a.status(200).json(o)}catch(t){a.status(500).json(t)}})),_.get("/api/search-project/:projectid",(async(t,e)=>{try{const a=await b.findById({_id:t.params.projectid}).populate({path:"employer",select:["firstname","middlename","lastname","companyinfo"]}).populate({path:"notes.notesender",select:["firstname","middlename","lastname","image"]}).populate({path:"applicants.applicantid",select:["firstname","middlename","lastname","image"]}).populate({path:"tempcandidate.applicantid",select:["firstname","middlename","lastname","image"]}).populate({path:"employeelist.employeeid",select:["firstname","middlename","lastname","image"]});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/add-candidate/:projectid/:candidate",(async(t,e)=>{const a=t.params.projectid,s=t.params.candidate;try{const t=await b.findByIdAndUpdate({_id:a},{$addToSet:{tempcandidate:{applicantid:s,employmentstatus:"Hiring"}}});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/update-project/accepted/:projectid/:candidate/:toHire",(async(t,e)=>{try{let a;0!==(await b.findById({_id:t.params.projectid}))?.slots&&(a=await b.findByIdAndUpdate({_id:t.params.projectid},{$addToSet:{employeelist:{employeeid:t.params.candidate,employmentstatus:"Ongoing",beganAt:Date.now()}},$pull:{tempcandidate:{applicantid:t.params.candidate},applicants:{applicantid:t.params.candidate}},$inc:{slots:-1}}),1===a.slots&&await b.findByIdAndUpdate({_id:t.params.projectid},{status:"Ongoing"}),await g.findByIdAndUpdate({_id:t.params.candidate},{$addToSet:{currentprojects:t.params.projectid}})),e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/update-project/rejected/:projectid/:employer/:userid",(async(t,e)=>{const a=t.params.projectid;let s;try{const o=await b.findById({_id:a});t.params.employer!==t.params.userid&&(s=await b.findByIdAndUpdate({_id:a},{$push:{notes:{notesender:t.params.userid,note:t.body.note}},$pull:{tempcandidate:{applicantid:t.params.userid}}})),e.status(200).json(s||o)}catch(t){e.status(500).json(t)}})),_.post("/api/update-project/apply/:projectid/:tempfree/:appliedAt",(async(t,e)=>{try{const a=await b.findByIdAndUpdate({_id:t.params.projectid},{$addToSet:{applicants:{applicantid:t.params.tempfree,appliedAt:t.params.appliedAt}}}).populate({path:"applicants.applicantid",select:["firstname","middlename","lastname","photo"]});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/update-project/read-note/:projectid/:noteid",(async(t,e)=>{try{const a=await b.findByIdAndUpdate({_id:t.params.projectid},{$pull:{notes:{_id:t.params.noteid}}});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/create-updates",U.single("photo"),(async(t,e)=>{try{const a={projectId:t.body.projectid,title:"",photo:"",description:"",note:t.body.note,uploadedby:""};await j.create(a,((t,a)=>{t?console.log(t):e.status(200).json(a)}))}catch(t){e.status(500).json(t)}})),_.get("/api/updates/:projectid",(async(t,e)=>{const a=t.params.projectid;try{const t=await j.find({projectId:a}).sort({createdAt:1});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/project-update/edit",U.single("photo"),(async(e,a)=>{if(e.file){const s={title:e.body.title,description:e.body.description,uploadedby:e.body.uploadedby};u.utils.api_sign_request({public_id:e.body.public_id,version:e.body.version},O.api_secret)===e.body.signature&&(s.image=e.body.image);try{s.photo=e.file.filename;const o=await j.findOneAndUpdate({_id:new t(e.body._id)},{$set:s});o.photo&&d.remove(n.join("public","uploaded-photos",o.photo)),o.image&&u.uploader.destroy(o.image),a.status(200).json(o)}catch(t){a.status(500).json(t)}}else{const s={title:e.body.title,description:e.body.description,uploadedby:e.body.uploadedby};try{const o=await j.findOneAndUpdate({_id:new t(e.body._id)},{$set:s});a.status(200).json(o)}catch(t){a.status(500).json(t)}}})),_.post("/api/end-project/:projectid",(async(e,a)=>{const s={status:"Concluded",completiondate:Date.now()};try{await b.findOneAndUpdate({_id:new t(e.params.projectid)},{$set:s});const o=await b.findOneAndUpdate({_id:new t(e.params.projectid)},{$set:{"employeelist.$[haha].completiondate":Date.now(),"employeelist.$[haha].employmentstatus":"Concluded"}},{arrayFilters:[{"haha.employmentstatus":"Ongoing"}]});a.status(200).json(o)}catch(t){a.status(500).json(t)}})),_.post("/api/end-contract/:projectid/:employeeid",(async(e,a)=>{try{const s=await b.findOneAndUpdate({_id:new t(e.params.projectid)},{$set:{"employeelist.$[haha].completiondate":Date.now(),"employeelist.$[haha].employmentstatus":"Concluded"}},{arrayFilters:[{"haha.employeeid":e.params.employeeid}]});1===s.employeelist.length&&await b.findOneAndUpdate({_id:new t(e.params.projectid)},{$set:{status:"Concluded"}}),a.status(200).json(s)}catch(t){a.status(500).json(t)}})),_.post("/api/update-project/extend-post/:projectid",(async(t,e)=>{try{const a=await b.findByIdAndUpdate({_id:t.params.projectid},{requeststatus:"Pending"});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.get("/members/:memberId",(async(e,a)=>{const s=e.params.memberId;try{const e=await g.find({_id:t(s)});a.status(200).json(e)}catch(t){a.status(500).json(t)}})),_.post("/api/create-conversation",(async(t,e)=>{const a=t.body,s=new w({members:a});try{const t=await s.save();e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/conversations/:userId",(async(t,e)=>{try{const a=await w.find({members:{$in:[t.params.userId]}}).sort({updatedAt:-1});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.get("/api/get-conversation/",(async(t,e)=>{const a=t.query.member1,s=t.query.member2;try{const t=await w.findOne({members:{$all:[a,s]}});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/message",(async(e,a)=>{const s=new h(e.body);try{const o=await s.save();await w.findOneAndUpdate({_id:new t(e.body.conversationId)},{$inc:{messages:1}}),a.status(200).json(o)}catch(t){a.status(500).json(t)}})),_.get("/message/:conversationId",(async(t,e)=>{try{const a=await h.find({conversationId:t.params.conversationId});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.get("/api/second-search",(async(t,e)=>{const a=await g.find({type:"Candidate"});e.json(a)})),_.get("/api/second-categories",(async(t,e)=>{const a=await f.find({});e.json(a)})),_.get("/api/employee-search",(async(t,e)=>{const a=t.query.query,s=t.query.key,o=function(t){let e,a;return"A-Z (First Name)"===t?(e="firstname",a="1",{b:e,c:a}):"Z-A (First Name)"===t?(e="firstname",a="-1",{b:e,c:a}):"A-Z (Last Name)"===t?(e="lastname",a="1",{b:e,c:a}):"Z-A (Last Name)"===t?(e="lastname",a="-1",{b:e,c:a}):"Highest Rating"===t?(e="averagerating",a="-1",{b:e,c:a}):"Lowest Rating"===t?(e="averagerating",a="1",{b:e,c:a}):void 0}(t.query.sort);if("Skill"===s)try{const t=await g.find({skill:new RegExp(a,"i"),type:"Candidate"}).collation({locale:"en",strength:2}).sort({[o.b]:[o.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}if("Name"===s)try{const t=await g.find({$or:[{firstname:new RegExp(a,"i")},{lastname:new RegExp(a,"i")}],type:"Candidate"}).collation({locale:"en",strength:2}).sort({[o.b]:[o.c]});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/categories",(async(t,e)=>{try{const t=await f.find();e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/categories/tags/",(async(t,e)=>{const a=t.query.category;try{const t=await f.find({name:a}).select("tags");e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/add-tag/:categoryid/:tag",(async(t,e)=>{const a=t.params.tag.toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.substring(1))).join(" ");let s=!0;if((await f.findById({_id:t.params.categoryid})).tags?.map((t=>{t===a&&(s=!1)})),!1===s)e.status(200).json("The Tag already exists.");else if(!0===s)try{await f.findByIdAndUpdate({_id:t.params.categoryid},{$addToSet:{tags:a}}),await f.findOneAndUpdate({_id:t.params.categoryid},{$inc:{tagscount:1}}),e.status(200).json("Success!")}catch(t){e.status(500).json(t)}})),_.post("/api/remove-tag/:categoryid/:tag",(async(t,e)=>{const a=t.params.tag.toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.substring(1))).join(" ");let s=!1;if((await f.findById({_id:t.params.categoryid})).tags?.map((t=>{t===a&&(s=!0)})),!0===s)try{await f.findByIdAndUpdate({_id:t.params.categoryid},{$pull:{tags:a}}),await f.findOneAndUpdate({_id:t.params.categoryid},{$inc:{tagscount:-1}}),e.status(200).json(`Successfully removed ${a}!`)}catch(t){e.status(500).json(t)}else!1===s&&e.status(200).json("The Tag does not exists.")})),_.post("/api/category",(async(t,e)=>{const a=new f({name:t.body.name,tags:[t.body.tags]});try{const t=await a.save();e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/:name/tags",(async(t,e)=>{try{await f.findOneAndUpdate({name:t.body.name},{$addToSet:{tags:t.body.tags}}),await f.findOneAndUpdate({name:t.body.name},{$inc:{tagscount:1}}),e.status(200).json("Success")}catch(t){e.status(500).json(t)}})),_.get("/api/user-skill/:user",(async(e,a)=>{const s=e.params.user;try{const e=await g.findById({_id:new t(s)}).select("skill");a.status(200).json(e)}catch(t){a.status(500).json(t)}})),_.post("/api/remove-tag/",(async(e,a)=>{const s=e.body.params.user,o=e.body.params.tag;try{await g.findOneAndUpdate({_id:new t(s)},{$pull:{skill:o}});const e=await g.findOne({_id:new t(s)}).select("skill");a.status(200).json(e)}catch(t){a.status(500).json(t)}})),_.post("/api/add-tag/",(async(e,a)=>{const s=e.body.params.user,o=e.body.params.tag;try{await g.findOneAndUpdate({_id:new t(s)},{$addToSet:{skill:o}});const e=await g.findOne({_id:new t(s)}).select("skill");a.status(200).json(e)}catch(t){a.status(500).json(t)}})),_.get("/api/search-profile/:user",(async(t,e)=>{const a=t.params.user;try{const t=await g.findById(a).populate({path:"currentprojects",select:["type","title","duration","acceptdate","status"]});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/api/reviews/:projectid/:candidate",U.single("photo"),(async(e,a)=>{if(e.file)try{obj={projectId:e.params.projectid,candidate:e.params.candidate,description:e.body.description,rating:e.body.rating,uploadedby:e.body.uploadedby,empname:e.body.empname,freename:e.body.freename},u.utils.api_sign_request({public_id:e.body.public_id,version:e.body.version},O.api_secret)===e.body.signature&&(obj.photo=e.body.image),v.create(obj,((t,e)=>{t?console.log(t):console.log("Ok")})),await g.findByIdAndUpdate({_id:new t(e.params.candidate)},{$pull:{currentprojects:e.params.projectid}})}catch(t){a.status(500).json(t)}else try{obj={projectId:e.params.projectid,candidate:e.params.candidate,description:e.body.description,rating:e.body.rating,uploadedby:e.body.uploadedby,empname:e.body.empname,freename:e.body.freename},v.create(obj,((t,e)=>{t?console.log(t):console.log("Ok")})),await g.findByIdAndUpdate({_id:new t(e.params.candidate)},{$pull:{currentprojects:e.params.projectid}})}catch(t){a.status(500).json(t)}await g.findOneAndUpdate({_id:new t(e.params.candidate)},{$push:{ratings:e.body.rating}});const s=await g.find({_id:new t(e.params.candidate)});let o=0,n=0;!function(t){for(let e=0;e<t.length;e++)o+=t[e];n=o/t.length}(s[0].ratings),await g.findOneAndUpdate({_id:new t(e.params.candidate)},{averagerating:n.toFixed(1)}),a.status(200).send(!0)})),_.get("/api/average/:id",(async(t,e)=>{const a=await g.find({_id:t.params.id});let s=0,o=0;!function(t){for(let e=0;e<t.length;e++)s+=t[e];o=s/t.length}(a[0].ratings),e.status(200).json(o)})),_.get("/api/reviews/:projectid/:candidate",(async(t,e)=>{try{await v.findOne({projectId:t.params.projectid,candidate:t.params.candidate})?e.status(200).send(!0):e.status(200).send(!1)}catch(t){e.status(500).json(t)}})),_.get("/api/all-reviews/:candidate",(async(t,e)=>{try{const a=await v.find({candidate:t.params.candidate}).sort({createdAt:-1});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/gallery/upload-photo/:userId",U.single("photo"),(async(t,e)=>{if(console.log(t.body),t.file){const a={userId:t.body.userId,title:t.body.title,description:t.body.description};u.utils.api_sign_request({public_id:t.body.public_id,version:t.body.version},O.api_secret)===t.body.signature&&(a.image=t.body.image);try{a.photo=t.file.filename,await q.create(a,((t,a)=>{t?console.log(t):e.status(200).send(a)}))}catch(t){e.status(500).json(t)}}else e.status(200).send(!1)})),_.get("/api/gallery/:userId",(async(t,e)=>{try{const a=await q.find({userId:t.params.userId}).sort({createdAt:-1});e.status(200).json(a)}catch(t){e.status(500).json(t)}})),_.post("/api/gallery/update-photo/:photoId",U.single("photo"),(async(e,a)=>{const s={title:e.body.title,description:e.body.description};try{const o=await q.findOneAndUpdate({_id:new t(e.params.photoId)},{$set:s});a.status(200).json(o)}catch(t){a.status(500).json(t)}})),_.delete("/api/gallery/delete-photo/:photoId",(async(e,a)=>{"string"!=typeof e.params.photoId&&(e.params.photoId="");const s=await q.findOne({_id:new t(e.params.photoId)});s.photo&&d.remove(n.join("public","uploaded-photos",s.photo)),s.image&&u.uploader.destroy(s.image);try{const t=await q.deleteOne(s);a.status(200).json(t)}catch(t){a.status(500).json(t)}})),_.get("/api/get-admin",(async(t,e)=>{try{const t=await g.findOne({type:"Admin"});e.status(200).json({_id:t._id})}catch(t){e.status(500).json(t)}})),_.post("/api/send-notifications/:senderId/:recieverId/:action/:type/:subject",(async(t,e)=>{const a={senderId:t.params.senderId,recieverId:t.params.recieverId,type:t.params.type,action:t.params.action,subject:t.params.subject};try{const t=await $.create(a);e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/notifications/:user",y,(async(t,e)=>{if(t.params.user)try{const a=await $.find({recieverId:t.params.user}).populate({path:"senderId",select:["firstname","middlename","lastname","image"]}).sort({createdAt:-1});e.status(200).json(a)}catch(t){e.status(500).json(t)}t.params.user||e.status(200).send(!1)})),_.post("/api/update-notifications/:_id",(async(e,a)=>{const s={cleared:"Yes"};try{await $.findByIdAndUpdate({_id:new t(e.params._id)},{$set:s}),a.status(200).json("Yes")}catch(t){a.status(500).json(t)}})),_.post("/api/read-all-notifications/:userid/:type",(async(e,a)=>{const s={cleared:"Yes"};if("All"===e.params.type)try{if(await $.updateMany({recieverId:new t(e.params.userid),cleared:"No"},{$set:s})){const t=await $.find({recieverId:e.params.userid}).populate({path:"senderId",select:["firstname","middlename","lastname","photo"]}).sort({createdAt:-1});a.status(200).json(t)}else a.status(200).json("Allready read all.")}catch(t){a.status(500).json(t)}if("Message"===e.params.type)try{const o=await $.updateMany({recieverId:new t(e.params.userid),type:e.params.type,cleared:"No"},{$set:s});a.status(200).json(o)}catch(t){a.status(500).json(t)}if("Request"===e.params.type)try{const o=await $.updateMany({recieverId:new t(e.params.userid),$or:[{type:"Project Request"},{type:"Job Request"}],cleared:"No"},{$set:s});a.status(200).json(o)}catch(t){a.status(500).json(t)}if("All Project"===e.params.type)try{const o=await $.updateMany({recieverId:new t(e.params.userid),$or:[{type:"Project Update"},{type:"Project Update Request"},{type:"Project Request"},{type:"Project"},{type:"Job Request"},{type:"Job"}],cleared:"No"},{$set:s});a.status(200).json(o)}catch(t){a.status(500).json(t)}})),_.get("/api/account-settings/:userid/:email/:password",(async(e,a)=>{try{const s=await g.find({_id:new t(e.params.userid),email:e.params.email}),o=await p.compare(e.params.password,s[0].password);!1===o&&a.status(200).send(!1),!0===o&&a.status(200).json(!0)}catch(t){a.status(200).send(!1)}})),_.post("/api/account-settings/change-password/:userid/:password",(async(e,a)=>{const s=await p.hash(e.params.password,10);try{const o=await g.findByIdAndUpdate({_id:new t(e.params.userid)},{password:s});o&&a.status(200).send(!0),o||a.status(200).send(!1)}catch(t){a.status(200).send(!1)}})),_.get("/api/reports/account-reports/:month/:year",(async(t,e)=>{let a=Number(t.params.month),s=Number(t.params.year);const o=await g.find({$or:[{type:"Employer"},{type:"Candidate"}]}),n=await g.aggregate([{$addFields:{month:{$month:"$lastactive"},year:{$year:"$lastactive"}}},{$match:{$and:[{month:a},{year:s},{$or:[{type:"Employer"},{type:"Candidate"}]}]}}]),i=(await g.aggregate([{$addFields:{month:{$month:"$lastactive"},year:{$year:"$lastactive"}}},{$match:{$and:[{month:a},{year:s},{type:"Employer"}]}}]),await g.aggregate([{$addFields:{month:{$month:"$lastactive"},year:{$year:"$lastactive"}}},{$match:{$and:[{month:a},{year:s},{type:"Candidate"}]}}]),{users:[{id:1,type:"Overall User Count",count:o.length},{id:2,type:"Active Users",count:n.length}],allUsers:n});e.status(200).send(i)})),_.get("/api/reports/ongoing-projects",(async(t,e)=>{const a=await b.find({status:"Ongoing",type:"Job"}),s=await b.find({status:"Ongoing",type:"Project"}),o={total:a.length+s.length,partial:[{id:1,type:"Job",count:a.length,data:a},{id:2,type:"Project",count:s.length,data:s}]};e.status(200).send(o)})),_.get("/api/reports/annual-reports/:month/:year",(async(t,e)=>{let a,s,o,n,r=Number(t.params.month),d=Number(t.params.year),p=[],c=[],l=[],y=[];for(i=r+1-r;i<13;i++)a=await b.aggregate([{$addFields:{month:{$month:"$creationdate"},year:{$year:"$creationdate"}}},{$match:{$and:[{month:i},{year:d},{$or:[{type:"Job Request"},{type:"Project Request"},{type:"Job"},{type:"Project"}]}]}}]),p=p.concat({count:a.length,data:a}),s=await b.aggregate([{$addFields:{month:{$month:"$approvaldate"},year:{$year:"$approvaldate"}}},{$match:{$and:[{month:i},{year:d},{$or:[{type:"Job"},{type:"Project"}]}]}}]),c=c.concat({count:s.length,data:s}),o=await b.aggregate([{$addFields:{month:{$month:"$creationdate"},year:{$year:"$creationdate"}}},{$match:{$and:[{month:i},{year:d},{$or:[{type:"Job Request"},{type:"Project Request"}]}]}}]),l=l.concat({count:o.length,data:o}),n=await b.aggregate([{$addFields:{month:{$month:"$completiondate"},year:{$year:"$completiondate"}}},{$match:{$and:[{month:i},{year:d},{$or:[{type:"Job"},{type:"Project"}]}]}}]),y=y.concat({count:n.length,data:n});let m=[],u=[],g=[],w=[];for(i=0;i<12;i++)m=m.concat({id:i+1,count:p[i].count,data:p[i].data}),u=u.concat({id:i+1,count:c[i].count,data:c[i].data}),g=g.concat({id:i+1,count:l[i].count,data:l[i].data}),w=w.concat({id:i+1,count:y[i].count,data:y[i].data});const h={requestReport:m,approvedReport:u,deniedReport:g,accomplishedReport:w};e.status(200).send(h)})),_.get("/api/reports/all-projects",(async(t,e)=>{const a=await b.find();e.status(200).send(a)})),_.get("/api/reports/all-requests",(async(t,e)=>{const a=t.query.startDate,s=t.query.endDate;let o;try{const t=await b.find({creationdate:{$gte:a,$lt:s}}).populate({path:"employer",select:["firstname","middlename","lastname"]}).populate({path:"employeelist.employeeid",select:["firstname","middlename","lastname","image"]}),n=t?.filter((t=>"Approved"===t.requeststatus)),i=t?.filter((t=>"Denied"===t.requeststatus)),r=t?.filter((t=>"Pending"===t.requeststatus));o={requests:{data:t},subtotal:[{id:1,type:"Approved",count:n.length,data:n},{id:2,type:"Denied",count:i.length,data:i},{id:3,type:"Pending",count:r.length,data:r}]},e.status(200).send(o)}catch(t){console.log(t)}})),_.get("/api/reports/all-completed-jobs&projects",(async(t,e)=>{const a=t.query.startDate,s=t.query.endDate;let o;try{const t=await b.find({completiondate:{$gte:a,$lt:s}}),n=t?.filter((t=>"Project"===t.type)),i=t?.filter((t=>"Job"===t.type));o={jobs:{data:t},subtotal:[{id:1,type:"Project",count:n.length,data:n},{id:2,type:"Job",count:i.length,data:i}]},e.status(200).send(o)}catch(t){console.log(t)}})),_.post("/api/answers/:userid/:projectid",(async(t,e)=>{obj={candidate:t.params.userid,project:t.params.projectid,answers:[t.body.answer1,t.body.answer2,t.body.answer3,t.body.answer4,t.body.answer5,t.body.answer6,t.body.answer7,t.body.answer8,t.body.answer9,t.body.answer10]};try{await S.create(obj),e.status(200).send(!0)}catch(t){e.status(200).send(!1)}})),_.get("/api/answers/:userid/:projectid",(async(t,e)=>{try{const a=await S.findOne({candidate:t.params.userid,project:t.params.projectid});e.status(200).send(a)}catch(t){e.status(400).json(t)}})),_.post("/api/bug-report",U.single("photo"),(async(t,e)=>{obj={userid:t.body.userid,title:t.body.title,description:t.body.description},u.utils.api_sign_request({public_id:t.body.public_id,version:t.body.version},O.api_secret)===t.body.signature&&(obj.photo=t.body.photo);try{await A.create(obj),e.status(200).send(!0)}catch(t){e.status(200).send(!1)}})),_.get("/api/all-bug-report",(async(t,e)=>{try{const t=await A.find().populate({path:"userid",select:["firstname","middlename","lastname"]});e.status(200).send(t)}catch(t){e.status(400).send(t)}})),_.post("/api/upload/company-details",U.single("photo"),(async(e,a)=>{if(e.file){obj={companyname:e.body.companyname,logo:void 0,companysize:e.body.companysize,details:e.body.companyinfo,establishdate:e.body.establishdate,location:{region:e.body.region,province:e.body.province,city:e.body.city}},u.utils.api_sign_request({public_id:e.body.public_id,version:e.body.version},O.api_secret)===e.body.signature&&(obj.logo=e.body.image);const s=await g.findOneAndUpdate({_id:new t(e.body.employerid)},{$set:{companyinfo:obj}});s.companyinfo.logo&&u.uploader.destroy(s.companyinfo.logo),a.status(200).send(s)}else{obj={companyname:e.body.companyname,logo:"",companysize:e.body.companysize,details:e.body.companyinfo,establishdate:e.body.establishdate,location:{region:e.body.region,province:e.body.province,city:e.body.city}};const s=await g.findOneAndUpdate({_id:new t(e.body.employerid)},{$set:{companyinfo:obj}});a.status(200).send(s)}})),_.post("/api/admin-logs/:adminId/:userId/:projectId/:type",(async(t,e)=>{const a={adminId:t.params.adminId,userId:t.params.userId,projectId:t.params.projectId,type:t.params.type};try{const t=await I.create(a);e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.get("/api/all-logs",(async(t,e)=>{try{const t=await I.find().populate({path:"adminId",select:["firstname","middlename","lastname"]}).populate({path:"userId",select:["firstname","middlename","lastname"]}).populate({path:"projectId",select:["title"]}).sort({createdAt:-1});e.status(200).json(t)}catch(t){e.status(500).json(t)}})),_.post("/tokenIsValid",(async(t,e)=>{try{const a=t.header("auth-token");if(!a)return e.json("false");const s=l.verify(a,process.env.JWT_SECRET);return s&&await g.findById(s._id)?e.json(!0):e.json("false")}catch{e.status(500)}}))})()})();